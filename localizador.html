<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Localizador por Radio</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      line-height: 1.6;
    }

    header {
      background: #333;
      color: rgba(185, 174, 174, 0.863);
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .btn-home {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }

    .btn-home:hover {
      background-color: #0056b3;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .controls-card {
      background-color: white;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .radio-controls {
      display: flex;
      gap: 1rem;
      align-items: end;
      justify-content: center;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }

    .input-group label {
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .input-group select {
      padding: 0.8rem;
      border: 2px solid #333;
      border-radius: 5px;
      font-size: 0.9rem;
      background-color: white;
    }

    .info-section {
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }

    .route-slider-container {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border: 2px solid #ddd;
      border-radius: 8px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .slider-btn {
      padding: 0.5rem 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .slider-btn:hover:not(:disabled) {
      background-color: #0056b3;
    }

    .slider-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .slider-info {
      font-weight: bold;
      font-size: 1rem;
    }

    .route-details {
      padding: 1rem;
      background-color: white;
      border-radius: 5px;
      margin-bottom: 1rem;
    }

    .btn-show-all {
      width: 100%;
      padding: 0.8rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-show-all:hover {
      background-color: #218838;
    }

    .btn-secondary {
      padding: 0.8rem 1.5rem;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .map-container {
      width: 100%;
      margin-bottom: 1rem;
    }

    #map {
      height: 500px;
      width: 100%;
      border: 2px solid #333;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      .radio-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group {
        min-width: 100%;
      }

      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <h1 id="page-header">Localizador por Radio</h1>
      <button id="btn-inicio" class="btn-home" onclick="window.location.href='index.html'">üè† Inicio</button>
    </div>
  </header>

  <main class="container">
    <div class="controls-card">
      <div class="radio-controls">
        <div class="input-group">
          <label for="radio-busqueda">Radio de B√∫squeda:</label>
          <select id="radio-busqueda" name="radio-busqueda">
            <option value="200">200 metros</option>
            <option value="500" selected>500 metros</option>
            <option value="1000">1000 metros</option>
          </select>
        </div>
        <button id="btn-limpiar" class="btn-secondary">Limpiar Mapa</button>
      </div>
      
      <div id="info" class="info-section">
        <b>Haz clic en el mapa para colocar un marcador y buscar rutas cercanas</b>
      </div>

      <div id="route-slider-container" class="route-slider-container" style="display: none;">
        <div class="slider-header">
          <button id="btn-prev-route" class="slider-btn">‚óÄ Anterior</button>
          <div class="slider-info">
            <span id="route-counter">Ruta 1 de 1</span>
          </div>
          <button id="btn-next-route" class="slider-btn">Siguiente ‚ñ∂</button>
        </div>
        <div class="route-details" id="route-details"></div>
        <button id="btn-show-all" class="btn-show-all">Mostrar Todas las Rutas</button>
      </div>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
const map = L.map("map").setView([10.9685, -74.7813], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap contributors"
}).addTo(map);

let searchMarker = null;
let searchCircle = null;
let polylines = [];
let markers = [];
let pageNameSet = false;
let rutasData = [];
let rutaActual = 0;
let mostrandoTodas = false;

const routeColors = [
  '#0066CC', '#FF6600', '#00CC66', '#CC0066', '#6600CC',
  '#CCCC00', '#00CCCC', '#CC6600', '#0099CC', '#CC0099'
];

function limpiarMapa() {
  if (searchMarker) {
    map.removeLayer(searchMarker);
    searchMarker = null;
  }
  if (searchCircle) {
    map.removeLayer(searchCircle);
    searchCircle = null;
  }
  polylines.forEach(polyline => map.removeLayer(polyline));
  polylines = [];
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  rutasData = [];
  rutaActual = 0;
  mostrandoTodas = false;
  document.getElementById('route-slider-container').style.display = 'none';
  document.getElementById("info").innerHTML = `<b>Haz clic en el mapa para colocar un marcador y buscar rutas cercanas</b>`;
}

function limpiarRutas() {
  polylines.forEach(polyline => map.removeLayer(polyline));
  polylines = [];
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  rutasData = [];
  rutaActual = 0;
  mostrandoTodas = false;
  document.getElementById('route-slider-container').style.display = 'none';
}

function dividirRutasPorTiempo(puntos, minutos = 30) {
  if (puntos.length === 0) return [];
  const rutas = [];
  let rutaActual = [puntos[0]];
  
  for (let i = 1; i < puntos.length; i++) {
    const tiempoActual = new Date(puntos[i].timestamp);
    const tiempoAnterior = new Date(puntos[i - 1].timestamp);
    const diferenciaMinutos = (tiempoActual - tiempoAnterior) / (1000 * 60);
    
    if (diferenciaMinutos <= minutos) {
      rutaActual.push(puntos[i]);
    } else {
      rutas.push(rutaActual);
      rutaActual = [puntos[i]];
    }
  }
  if (rutaActual.length > 0) {
    rutas.push(rutaActual);
  }
  return rutas;
}

function mostrarRuta(indice) {
  if (indice < 0 || indice >= rutasData.length) return;
  
  polylines.forEach(polyline => map.removeLayer(polyline));
  polylines = [];
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  
  mostrandoTodas = false;
  rutaActual = indice;
  
  const ruta = rutasData[indice];
  const color = routeColors[indice % routeColors.length];
  
  const routePoints = ruta.map(point => [parseFloat(point.lat), parseFloat(point.lng)]);
  
  if (routePoints.length > 1) {
    const polyline = L.polyline(routePoints, {
      color: color,
      weight: 4,
      opacity: 0.8,
      smoothFactor: 1
    }).addTo(map);
    polylines.push(polyline);
  }
  
  const startPoint = ruta[0];
  console.log('Punto de inicio:', startPoint); // DEBUG
  
  const startMarker = L.marker([startPoint.lat, startPoint.lng], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  startMarker.bindPopup(`
    <b>Ruta ${indice + 1} - Inicio:</b><br>
    ${formatearFechaLegible(startPoint.timestamp)}<br>
    <b>Lat:</b> ${startPoint.lat}<br>
    <b>Lon:</b> ${startPoint.lng}<br>
    <b>RPM:</b> ${startPoint.rpm !== undefined ? startPoint.rpm : 'N/A'}<br>
    <b>Distancia:</b> ${startPoint.distancia || 'N/A'}m
  `);
  markers.push(startMarker);
  
  if (ruta.length > 1) {
    const endPoint = ruta[ruta.length - 1];
    console.log('Punto final:', endPoint); // DEBUG
    
    const endMarker = L.marker([endPoint.lat, endPoint.lng], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map);
    
    endMarker.bindPopup(`
      <b>Ruta ${indice + 1} - Fin:</b><br>
      ${formatearFechaLegible(endPoint.timestamp)}<br>
      <b>Lat:</b> ${endPoint.lat}<br>
      <b>Lon:</b> ${endPoint.lng}<br>
      <b>RPM:</b> ${endPoint.rpm !== undefined ? endPoint.rpm : 'N/A'}<br>
      <b>Distancia:</b> ${endPoint.distancia || 'N/A'}m
    `);
    markers.push(endMarker);
  }
  
  const inicio = formatearFechaLegible(ruta[0].timestamp);
  const fin = ruta.length > 1 ? formatearFechaLegible(ruta[ruta.length - 1].timestamp) : inicio;
  
  document.getElementById('route-counter').textContent = `Ruta ${indice + 1} de ${rutasData.length}`;
  document.getElementById('route-details').innerHTML = `
    <div style="border-left: 4px solid ${color}; padding-left: 10px;">
      <b style="color: ${color}; font-size: 1.1em;">Ruta ${indice + 1}</b><br>
      <b>üìç Puntos:</b> ${ruta.length}<br>
      <b>üïê Inicio:</b> ${inicio}<br>
      ${ruta.length > 1 ? `<b>üèÅ Fin:</b> ${fin}` : ''}
    </div>
  `;
  
  const allPoints = routePoints.slice();
  if (searchMarker) {
    const searchLatLng = searchMarker.getLatLng();
    allPoints.push([searchLatLng.lat, searchLatLng.lng]);
  }
  const bounds = L.latLngBounds(allPoints);
  map.fitBounds(bounds, { padding: [50, 50] });
  
  document.getElementById('btn-prev-route').disabled = (indice === 0);
  document.getElementById('btn-next-route').disabled = (indice === rutasData.length - 1);
  document.getElementById('btn-show-all').textContent = 'Mostrar Todas las Rutas';
}

function mostrarTodasLasRutas() {
  polylines.forEach(polyline => map.removeLayer(polyline));
  polylines = [];
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  
  mostrandoTodas = true;
  let allPoints = [];
  
  rutasData.forEach((ruta, index) => {
    if (ruta.length === 0) return;
    
    const color = routeColors[index % routeColors.length];
    const routePoints = ruta.map(point => [parseFloat(point.lat), parseFloat(point.lng)]);
    allPoints.push(...routePoints);
    
    if (routePoints.length > 1) {
      const polyline = L.polyline(routePoints, {
        color: color,
        weight: 3,
        opacity: 0.7,
        smoothFactor: 1
      }).addTo(map);
      polylines.push(polyline);
    }
    
    const startPoint = ruta[0];
    const startMarker = L.marker([startPoint.lat, startPoint.lng], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map);
    
    startMarker.bindPopup(`
      <b>Ruta ${index + 1} - Inicio:</b><br>
      ${formatearFechaLegible(startPoint.timestamp)}<br>
      <b>Lat:</b> ${startPoint.lat}<br>
      <b>Lon:</b> ${startPoint.lng}<br>
      <b>RPM:</b> ${startPoint.rpm !== undefined ? startPoint.rpm : 'N/A'}<br>
      <b>Distancia:</b> ${startPoint.distancia || 'N/A'}m
    `);
    markers.push(startMarker);
    
    if (ruta.length > 1) {
      const endPoint = ruta[ruta.length - 1];
      const endMarker = L.marker([endPoint.lat, endPoint.lng], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map);
      
      endMarker.bindPopup(`
        <b>Ruta ${index + 1} - Fin:</b><br>
        ${formatearFechaLegible(endPoint.timestamp)}<br>
        <b>Lat:</b> ${endPoint.lat}<br>
        <b>Lon:</b> ${endPoint.lng}<br>
        <b>RPM:</b> ${endPoint.rpm !== undefined ? endPoint.rpm : 'N/A'}<br>
        <b>Distancia:</b> ${endPoint.distancia || 'N/A'}m
      `);
      markers.push(endMarker);
    }
  });
  
  document.getElementById('route-counter').textContent = `Mostrando todas las rutas (${rutasData.length})`;
  
  let detailsHTML = '<div><b style="font-size: 1.1em;">Todas las Rutas:</b><br>';
  rutasData.forEach((ruta, index) => {
    const color = routeColors[index % routeColors.length];
    const inicio = formatearFechaLegible(ruta[0].timestamp);
    detailsHTML += `<div style="margin-top: 8px; border-left: 4px solid ${color}; padding-left: 10px;">`;
    detailsHTML += `<b style="color: ${color}">Ruta ${index + 1}:</b> ${ruta.length} punto${ruta.length > 1 ? 's' : ''} | ${inicio}`;
    detailsHTML += `</div>`;
  });
  detailsHTML += '</div>';
  
  document.getElementById('route-details').innerHTML = detailsHTML;
  
  if (searchMarker) {
    const searchLatLng = searchMarker.getLatLng();
    allPoints.push([searchLatLng.lat, searchLatLng.lng]);
  }
  const bounds = L.latLngBounds(allPoints);
  map.fitBounds(bounds, { padding: [50, 50] });
  
  document.getElementById('btn-show-all').textContent = 'Volver a Vista Individual';
}

async function consultarUbicacionesCercanas(lat, lng, radio) {
  document.getElementById("info").innerHTML = `<b>Buscando ubicaciones dentro de ${radio}m del punto seleccionado...</b>`;
  
  try {
    const url = `localizador.php?lat=${lat}&lng=${lng}&radio=${radio}`;
    console.log('Consultando URL:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const responseText = await response.text();
    console.log('Respuesta cruda del servidor:', responseText);
    
    let data;
    try {
      data = JSON.parse(responseText);
      console.log('Datos parseados correctamente:', data);
    } catch (jsonError) {
      console.error('Error parseando JSON:', jsonError);
      document.getElementById("info").innerHTML = `<b style="color: red;">Error:</b> Respuesta inv√°lida del servidor.`;
      return;
    }
    
    if (data.error) {
      document.getElementById("info").innerHTML = `<b style="color: red;">Error:</b> ${data.error}`;
      return;
    }
    
    if (!pageNameSet && data.pageName) {
      document.title = data.pageName;
      pageNameSet = true;
    }
    
    let locationData = [];
    if (Array.isArray(data)) {
      locationData = data;
    } else if (data.locations && Array.isArray(data.locations)) {
      locationData = data.locations;
    } else if (data.data && Array.isArray(data.data)) {
      locationData = data.data;
    }
    
    console.log(`Total de puntos recibidos: ${locationData.length}`);
    console.log('Primer punto (para verificar RPM):', locationData[0]); // DEBUG
    
    if (locationData.length > 0) {
      const puntosValidos = locationData.filter(point => 
        point.lat && point.lng && 
        !isNaN(parseFloat(point.lat)) && 
        !isNaN(parseFloat(point.lng))
      );
      
      if (puntosValidos.length === 0) {
        document.getElementById("info").innerHTML = `<b>No se encontraron ubicaciones v√°lidas dentro del radio de ${radio}m.</b>`;
        return;
      }
      
      rutasData = dividirRutasPorTiempo(puntosValidos, 30);
      console.log(`Se encontraron ${rutasData.length} ruta(s)`);
      
      let totalPuntos = rutasData.reduce((sum, ruta) => sum + ruta.length, 0);
      
      document.getElementById("info").innerHTML = `
        <b>üìä Resultados:</b> ${totalPuntos} punto${totalPuntos > 1 ? 's' : ''} en ${rutasData.length} ruta${rutasData.length > 1 ? 's' : ''}<br>
        <b>üéØ Radio de b√∫squeda:</b> ${radio}m
      `;
      
      document.getElementById('route-slider-container').style.display = 'block';
      rutaActual = 0;
      mostrarRuta(0);
      
    } else {
      document.getElementById("info").innerHTML = `<b>No se encontraron ubicaciones dentro del radio de ${radio}m.</b>`;
      document.getElementById('route-slider-container').style.display = 'none';
    }
    
  } catch (err) {
    console.error("Error:", err);
    document.getElementById("info").innerHTML = `<b style="color: red;">Error:</b> ${err.message}`;
  }
}

map.on('click', function(e) {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  const radio = parseInt(document.getElementById('radio-busqueda').value);
  
  limpiarRutas();
  
  if (searchMarker) map.removeLayer(searchMarker);
  if (searchCircle) map.removeLayer(searchCircle);
  
  searchMarker = L.marker([lat, lng], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  searchMarker.bindPopup(`<b>Punto de b√∫squeda</b><br>Radio: ${radio}m<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`).openPopup();
  
  searchCircle = L.circle([lat, lng], {
    radius: radio,
    color: 'orange',
    fillColor: '#ffa500',
    fillOpacity: 0.2,
    weight: 2
  }).addTo(map);
  
  consultarUbicacionesCercanas(lat, lng, radio);
});

document.getElementById('radio-busqueda').addEventListener('change', function() {
  if (searchMarker && searchCircle) {
    const radio = parseInt(this.value);
    const lat = searchMarker.getLatLng().lat;
    const lng = searchMarker.getLatLng().lng;
    
    limpiarRutas();
    map.removeLayer(searchCircle);
    
    searchCircle = L.circle([lat, lng], {
      radius: radio,
      color: 'orange',
      fillColor: '#ffa500',
      fillOpacity: 0.2,
      weight: 2
    }).addTo(map);
    
    searchMarker.setPopupContent(`<b>Punto de b√∫squeda</b><br>Radio: ${radio}m<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`);
    consultarUbicacionesCercanas(lat, lng, radio);
  }
});

document.getElementById('btn-prev-route').addEventListener('click', function() {
  if (rutaActual > 0) mostrarRuta(rutaActual - 1);
});

document.getElementById('btn-next-route').addEventListener('click', function() {
  if (rutaActual < rutasData.length - 1) mostrarRuta(rutaActual + 1);
});

document.getElementById('btn-show-all').addEventListener('click', function() {
  if (mostrandoTodas) {
    mostrarRuta(rutaActual);
  } else {
    mostrarTodasLasRutas();
  }
});

document.getElementById('btn-limpiar').addEventListener('click', function() {
  limpiarMapa();
});

document.addEventListener('keydown', function(e) {
  if (rutasData.length === 0) return;
  if (e.key === 'ArrowLeft' && rutaActual > 0 && !mostrandoTodas) {
    mostrarRuta(rutaActual - 1);
  } else if (e.key === 'ArrowRight' && rutaActual < rutasData.length - 1 && !mostrandoTodas) {
    mostrarRuta(rutaActual + 1);
  }
});

function handleResize() {
  setTimeout(() => map.invalidateSize(), 100);
}

function formatearFechaLegible(fechaString) {
  try {
    const fecha = new Date(fechaString);
    if (isNaN(fecha.getTime())) return fechaString;
    const opciones = {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    return fecha.toLocaleDateString('es-ES', opciones);
  } catch {
    return fechaString;
  }
}

window.addEventListener('resize', handleResize);
  </script>
</body>
</html>