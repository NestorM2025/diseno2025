<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Cargando...</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <div class="header-container">
      <h1 id="page-header">Localizador Hist√≥rico</h1>
      <button id="btn-inicio" class="btn-home" onclick="window.location.href='index.html'">üè† Inicio</button>
    </div>
  </header>

  <main class="container">
    <div class="controls-card">
      <div class="date-controls">
        <div class="input-group">
          <label for="vehiculo-select">Veh√≠culo:</label>
          <select id="vehiculo-select" name="vehiculo-select">
            <option value="1">üöó Veh√≠culo 1</option>
            <option value="2">üöô Veh√≠culo 2</option>
            <option value="ambos">üöóüöô Ambos Veh√≠culos</option>
          </select>
        </div>
        <div class="input-group">
          <label for="fecha-inicio">Fecha de Inicio:</label>
          <input type="datetime-local" id="fecha-inicio" name="fecha-inicio">
        </div>
        <div class="input-group">
          <label for="fecha-fin">Fecha de Fin:</label>
          <input type="datetime-local" id="fecha-fin" name="fecha-fin">
        </div>
        <button id="btn-consultar" class="btn-primary">Consultar Recorrido</button>
      </div>
    </div>

    <div id="info" class="info-card">
      <b>Selecciona un veh√≠culo y un rango de fechas para ver el recorrido hist√≥rico</b>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
// Inicializar mapa sin ubicaci√≥n espec√≠fica
const map = L.map("map").setView([0, 0], 2); // Vista mundial por defecto

// Cargar tiles de OpenStreetMap
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap contributors"
}).addTo(map);

let polylines = [];
let markers = [];
let pageNameSet = false;

// Funci√≥n para limpiar el mapa
function limpiarMapa() {
  polylines.forEach(polyline => {
    map.removeLayer(polyline);
  });
  polylines = [];
  
  markers.forEach(marker => {
    map.removeLayer(marker);
  });
  markers = [];
}

// Funci√≥n para consultar recorrido hist√≥rico
async function consultarRecorrido() {
  const vehiculoId = document.getElementById('vehiculo-select').value;
  const fechaInicio = document.getElementById('fecha-inicio').value;
  const fechaFin = document.getElementById('fecha-fin').value;
  
  if (!fechaInicio || !fechaFin) {
    alert('Por favor selecciona tanto la fecha de inicio como la fecha de fin.');
    return;
  }
  
  if (new Date(fechaInicio) >= new Date(fechaFin)) {
    alert('La fecha de inicio debe ser anterior a la fecha de fin.');
    return;
  }
  
  // Limpiar mapa antes de mostrar nuevos datos
  limpiarMapa();
  
  // Deshabilitar bot√≥n mientras se carga
  const btnConsultar = document.getElementById('btn-consultar');
  btnConsultar.disabled = true;
  btnConsultar.textContent = 'Cargando...';
  
  if (vehiculoId === 'ambos') {
    await consultarAmbosVehiculos(fechaInicio, fechaFin);
  } else {
    await consultarUnVehiculo(vehiculoId, fechaInicio, fechaFin);
  }
  
  // Rehabilitar bot√≥n
  btnConsultar.disabled = false;
  btnConsultar.textContent = 'Consultar Recorrido';
}

async function consultarUnVehiculo(vehiculoId, fechaInicio, fechaFin) {
  const vehiculoNombre = vehiculoId === '1' ? 'Veh√≠culo 1 üöó' : 'Veh√≠culo 2 üöô';
  
  document.getElementById("info").innerHTML = `
    <b>Consultando datos de ${vehiculoNombre} desde ${formatearFechaLegible(fechaInicio)} hasta ${formatearFechaLegible(fechaFin)}...</b>
  `;
  
  try {
    const url = `historico.php?vehiculo_id=${vehiculoId}&fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const responseText = await response.text();
    let data;
    
    try {
      data = JSON.parse(responseText);
    } catch (jsonError) {
      console.error('Error parseando JSON:', jsonError);
      document.getElementById("info").innerHTML = `
        <b style="color: red;">Error:</b> Respuesta inv√°lida del servidor.
      `;
      return;
    }
    
    if (data.error) {
      document.getElementById("info").innerHTML = `
        <b style="color: red;">Error:</b> ${data.error}
      `;
      return;
    }
    
    if (!pageNameSet && data.pageName) {
      document.title = data.pageName;
      pageNameSet = true;
    }
    
    let locationData = [];
    if (Array.isArray(data)) {
      locationData = data;
    } else if (data.locations && Array.isArray(data.locations)) {
      locationData = data.locations;
    }
    
    if (locationData.length > 0) {
      const puntosValidos = locationData.filter(point => 
        point.lat && point.lng && 
        !isNaN(parseFloat(point.lat)) && 
        !isNaN(parseFloat(point.lng))
      );
      
      if (puntosValidos.length === 0) {
        document.getElementById("info").innerHTML = `
          <b>No se encontraron puntos v√°lidos para el ${vehiculoNombre}.</b>
        `;
        return;
      }
      
      const routePoints = puntosValidos.map(point => [parseFloat(point.lat), parseFloat(point.lng)]);
      const routeColor = vehiculoId === '1' ? 'blue' : 'red';
      
      if (routePoints.length > 1) {
        const polyline = L.polyline(routePoints, {
          color: routeColor,
          weight: 3,
          opacity: 0.7,
          smoothFactor: 1
        }).addTo(map);
        polylines.push(polyline);
        
        map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
      } else {
        map.setView([routePoints[0][0], routePoints[0][1]], 15);
      }
      
      agregarMarcadores(puntosValidos, vehiculoNombre, vehiculoId);
      
      const inicio = formatearFechaLegible(puntosValidos[0].timestamp);
      const fin = puntosValidos.length > 1 ? formatearFechaLegible(puntosValidos[puntosValidos.length - 1].timestamp) : inicio;
      
      document.getElementById("info").innerHTML = `
        <b>${vehiculoNombre} - Recorrido encontrado:</b> ${puntosValidos.length} punto${puntosValidos.length > 1 ? 's' : ''} | 
        <b>Inicio:</b> ${inicio} ${puntosValidos.length > 1 ? `| <b>Fin:</b> ${fin}` : ''}
      `;
      
    } else {
      document.getElementById("info").innerHTML = `
        <b>No se encontraron datos para el ${vehiculoNombre} en el per√≠odo seleccionado.</b>
      `;
    }
    
  } catch (err) {
    console.error("‚ùå Error:", err);
    document.getElementById("info").innerHTML = `
      <b style="color: red;">Error:</b> ${err.message}
    `;
  }
}

async function consultarAmbosVehiculos(fechaInicio, fechaFin) {
  document.getElementById("info").innerHTML = `
    <b>Consultando datos de ambos veh√≠culos desde ${formatearFechaLegible(fechaInicio)} hasta ${formatearFechaLegible(fechaFin)}...</b>
  `;
  
  try {
    // Consultar ambos veh√≠culos en paralelo
    const [response1, response2] = await Promise.all([
      fetch(`historico.php?vehiculo_id=1&fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}`),
      fetch(`historico.php?vehiculo_id=2&fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}`)
    ]);
    
    if (!response1.ok || !response2.ok) {
      throw new Error('Error en las consultas');
    }
    
    const [text1, text2] = await Promise.all([
      response1.text(),
      response2.text()
    ]);
    
    let data1, data2;
    try {
      data1 = JSON.parse(text1);
      data2 = JSON.parse(text2);
    } catch (jsonError) {
      console.error('Error parseando JSON:', jsonError);
      document.getElementById("info").innerHTML = `
        <b style="color: red;">Error:</b> Respuesta inv√°lida del servidor.
      `;
      return;
    }
    
    if (!pageNameSet && data1.pageName) {
      document.title = data1.pageName;
      pageNameSet = true;
    }
    
    // Procesar Veh√≠culo 1
    let puntos1 = [];
    if (data1.locations && Array.isArray(data1.locations)) {
      puntos1 = data1.locations.filter(point => 
        point.lat && point.lng && 
        !isNaN(parseFloat(point.lat)) && 
        !isNaN(parseFloat(point.lng))
      );
    }
    
    // Procesar Veh√≠culo 2
    let puntos2 = [];
    if (data2.locations && Array.isArray(data2.locations)) {
      puntos2 = data2.locations.filter(point => 
        point.lat && point.lng && 
        !isNaN(parseFloat(point.lat)) && 
        !isNaN(parseFloat(point.lng))
      );
    }
    
    if (puntos1.length === 0 && puntos2.length === 0) {
      document.getElementById("info").innerHTML = `
        <b>No se encontraron datos para ning√∫n veh√≠culo en el per√≠odo seleccionado.</b>
      `;
      return;
    }
    
    const allBounds = L.latLngBounds();
    
    // Dibujar recorrido Veh√≠culo 1
    if (puntos1.length > 0) {
      const routePoints1 = puntos1.map(point => [parseFloat(point.lat), parseFloat(point.lng)]);
      
      if (routePoints1.length > 1) {
        const polyline1 = L.polyline(routePoints1, {
          color: 'blue',
          weight: 3,
          opacity: 0.7,
          smoothFactor: 1
        }).addTo(map);
        polylines.push(polyline1);
        
        routePoints1.forEach(point => allBounds.extend(point));
      }
      
      agregarMarcadores(puntos1, 'Veh√≠culo 1 üöó', '1');
    }
    
    // Dibujar recorrido Veh√≠culo 2
    if (puntos2.length > 0) {
      const routePoints2 = puntos2.map(point => [parseFloat(point.lat), parseFloat(point.lng)]);
      
      if (routePoints2.length > 1) {
        const polyline2 = L.polyline(routePoints2, {
          color: 'red',
          weight: 3,
          opacity: 0.7,
          smoothFactor: 1
        }).addTo(map);
        polylines.push(polyline2);
        
        routePoints2.forEach(point => allBounds.extend(point));
      }
      
      agregarMarcadores(puntos2, 'Veh√≠culo 2 üöô', '2');
    }
    
    // Ajustar vista para mostrar ambos recorridos
    if (allBounds.isValid()) {
      map.fitBounds(allBounds, { padding: [30, 30] });
    }
    
    // Mostrar resumen
    const totalPuntos = puntos1.length + puntos2.length;
    document.getElementById("info").innerHTML = `
      <b>üìä Resultados de ambos veh√≠culos:</b><br>
      <span style="color: blue;">üöó Veh√≠culo 1:</span> ${puntos1.length} punto${puntos1.length !== 1 ? 's' : ''}<br>
      <span style="color: red;">üöô Veh√≠culo 2:</span> ${puntos2.length} punto${puntos2.length !== 1 ? 's' : ''}<br>
      <b>Total:</b> ${totalPuntos} puntos
    `;
    
  } catch (err) {
    console.error("‚ùå Error:", err);
    document.getElementById("info").innerHTML = `
      <b style="color: red;">Error:</b> ${err.message}
    `;
  }
}

function agregarMarcadores(puntos, vehiculoNombre, vehiculoId) {
  if (puntos.length === 0) return;
  
  const iconColor = vehiculoId === '1' ? 'blue' : 'red';
  
  // Marcador de inicio
  const startPoint = puntos[0];
  const startMarker = L.marker([startPoint.lat, startPoint.lng], {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map);
  
  startMarker.bindPopup(`
    <b>Inicio ${vehiculoNombre}:</b><br>
    ${startPoint.timestamp}<br>
    <b>Lat:</b> ${startPoint.lat}<br>
    <b>Lon:</b> ${startPoint.lng}<br>
    <b>RPM:</b> ${startPoint.rpm || 'N/A'}
  `);
  markers.push(startMarker);
  
  // Marcador de fin (solo si hay m√°s de un punto)
  if (puntos.length > 1) {
    const endPoint = puntos[puntos.length - 1];
    const endMarker = L.marker([endPoint.lat, endPoint.lng], {
      icon: L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map);
    
    endMarker.bindPopup(`
      <b>Fin ${vehiculoNombre}:</b><br>
      ${endPoint.timestamp}<br>
      <b>Lat:</b> ${endPoint.lat}<br>
      <b>Lon:</b> ${endPoint.lng}<br>
      <b>RPM:</b> ${endPoint.rpm || 'N/A'}
    `);
    markers.push(endMarker);
  }
}

// Funci√≥n para ajustar el mapa cuando cambia el tama√±o de ventana
function handleResize() {
  setTimeout(() => {
    map.invalidateSize();
  }, 100);
}

// Funci√≥n para formatear fecha de manera legible
function formatearFechaLegible(fechaString) {
  try {
    const fecha = new Date(fechaString);
    if (isNaN(fecha.getTime())) return fechaString;
    
    const opciones = {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    return fecha.toLocaleDateString('es-ES', opciones);
  } catch {
    return fechaString;
  }
}

// Funci√≥n para establecer fecha por defecto
function establecerFechasPorDefecto() {
  const ahora = new Date();
  const inicioDelDia = new Date(ahora);
  inicioDelDia.setHours(0, 0, 0, 0);
  
  const formatoFecha = (fecha) => {
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0');
    const day = String(fecha.getDate()).padStart(2, '0');
    const hours = String(fecha.getHours()).padStart(2, '0');
    const minutes = String(fecha.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };
  
  document.getElementById('fecha-inicio').value = formatoFecha(inicioDelDia);
  document.getElementById('fecha-fin').value = formatoFecha(ahora);
}

// Funci√≥n para validar fechas
function validarFechas() {
  const fechaInicio = document.getElementById('fecha-inicio').value;
  const fechaFin = document.getElementById('fecha-fin').value;
  
  if (fechaInicio && fechaFin) {
    if (new Date(fechaInicio) >= new Date(fechaFin)) {
      const nuevaFechaFin = new Date(fechaInicio);
      nuevaFechaFin.setHours(nuevaFechaFin.getHours() + 1);
      
      const formatoFecha = (fecha) => {
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const day = String(fecha.getDate()).padStart(2, '0');
        const hours = String(fecha.getHours()).padStart(2, '0');
        const minutes = String(fecha.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      };
      
      document.getElementById('fecha-fin').value = formatoFecha(nuevaFechaFin);
    }
  }
}

// Event listeners
document.getElementById('btn-consultar').addEventListener('click', consultarRecorrido);
window.addEventListener('resize', handleResize);
document.getElementById('fecha-inicio').addEventListener('change', validarFechas);
document.getElementById('fecha-fin').addEventListener('change', validarFechas);
document.getElementById('fecha-inicio').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') consultarRecorrido();
});
document.getElementById('fecha-fin').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') consultarRecorrido();
});

// Inicializar fechas por defecto al cargar
establecerFechasPorDefecto();
  </script>

  <style>
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      background-color: #333;
      border-bottom: 2px solid #333;
    }

    .btn-home {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }

    .btn-home:hover {
      background-color: #0056b3;
    }

    .date-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }

    .input-group label {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .input-group input,
    .input-group select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .input-group select {
      cursor: pointer;
      background-color: white;
    }

    .btn-primary {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      height: fit-content;
    }

    .btn-primary:hover {
      background-color: #218838;
    }

    .btn-primary:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .header-container {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .date-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group {
        min-width: 100%;
      }

      .btn-primary {
        width: 100%;
      }
    }
  </style>
</body>
</html>